parameters:
  - name: github_release
    displayName: Create Github Release
    type: boolean
    default: false
  - name: dockerhub_release
    displayName: Create Dockerhub Release
    type: boolean
    default: false

stages:
  - stage: Generate_toolchain
    jobs:
      - job: aarch64_gcc_8_5_0_glibc_2_28
        pool:
          vmImage: 'ubuntu-latest'
        timeoutInMinutes: 180
        steps:
          - template: build-toolchain.yml
            parameters:
              config: aarch64-gcc-8.5.0-glibc-2.28.config
              arch: arm64
              tuple: aarch64-linux-gnu
              pkg: aarch64-linux-gnu-glibc-2.28

      - job: aarch64_gcc_7_5_0_glibc_2_17
        pool:
          vmImage: 'ubuntu-latest'
        timeoutInMinutes: 180
        steps:
          - template: build-toolchain.yml
            parameters:
              config: aarch64-gcc-7.5.0-glibc-2.17.config
              arch: arm64
              tuple: aarch64-linux-gnu
              pkg: aarch64-linux-gnu-glibc-2.17

      - job: x86_64_gcc_8_5_0_glibc_2_28
        pool:
          vmImage: 'ubuntu-latest'
        timeoutInMinutes: 180
        steps:
          - template: build-toolchain.yml
            parameters:
              config: x86_64-gcc-8.5.0-glibc-2.28.config
              arch: amd64
              tuple: x86_64-linux-gnu
              pkg: x86_64-linux-gnu-glibc-2.28

      - job: x86_64_gcc_7_5_0_glibc_2_17
        pool:
          vmImage: 'ubuntu-latest'
        timeoutInMinutes: 180
        steps:
          - template: build-toolchain.yml
            parameters:
              config: x86_64-gcc-7.5.0-glibc-2.17.config
              arch: amd64
              tuple: x86_64-linux-gnu
              pkg: x86_64-linux-gnu-glibc-2.17

      - job: armhf_gcc_8_5_0_glibc_2_28
        pool:
          vmImage: 'ubuntu-latest'
        timeoutInMinutes: 180
        steps:
          - template: build-toolchain.yml
            parameters:
              arch: armhf
              config: armhf-gcc-8.5.0-glibc-2.28.config
              tuple: arm-rpi-linux-gnueabihf
              pkg: arm-rpi-linux-gnueabihf-glibc-2.28

      - job: armhf_gcc_7_5_0_glibc_2_17
        pool:
          vmImage: 'ubuntu-latest'
        timeoutInMinutes: 180
        steps:
          - template: build-toolchain.yml
            parameters:
              arch: armhf
              config: armhf-gcc-7.5.0-glibc-2.17.config
              tuple: arm-rpi-linux-gnueabihf
              pkg: arm-rpi-linux-gnueabihf-glibc-2.17

  - ${{ if parameters.github_release }}:
    - stage: Release_toolchain
      dependsOn:
        - Generate_toolchain
      pool:
        vmImage: 'ubuntu-latest'
      jobs:
        - job: Publish_to_Github
          variables:
            currentDate: $[ format('{0:yyyy}{0:MM}{0:dd}', pipeline.startTime) ]
          steps:
            - download: current
              patterns: |
                **/*.tar.gz
            - script: cp $(Pipeline.Workspace)/x86_64-linux-gnu-glibc-2.28/x86_64-linux-gnu-glibc-2.28.tar.gz $(Build.ArtifactStagingDirectory)/x86_64-linux-gnu-glibc-2.28.tar.gz
              displayName: Copy x86_64 glibc 2.28 toolchain
            - script: cp $(Pipeline.Workspace)/aarch64-linux-gnu-glibc-2.28/aarch64-linux-gnu-glibc-2.28.tar.gz $(Build.ArtifactStagingDirectory)/aarch64-linux-gnu-glibc-2.28.tar.gz
              displayName: Copy aarch64 glibc 2.28 toolchain
            - script: cp $(Pipeline.Workspace)/arm-rpi-linux-gnueabihf-glibc-2.28/arm-rpi-linux-gnueabihf-glibc-2.28.tar.gz $(Build.ArtifactStagingDirectory)/arm-rpi-linux-gnueabihf-glibc-2.28.tar.gz
              displayName: Copy armhf glibc 2.28 toolchain
            - script: cp $(Pipeline.Workspace)/x86_64-linux-gnu-glibc-2.17/x86_64-linux-gnu-glibc-2.17.tar.gz $(Build.ArtifactStagingDirectory)/x86_64-linux-gnu-glibc-2.17.tar.gz
              displayName: Copy x86_64 glibc 2.17 toolchain
            - script: cp $(Pipeline.Workspace)/aarch64-linux-gnu-glibc-2.17/aarch64-linux-gnu-glibc-2.17.tar.gz $(Build.ArtifactStagingDirectory)/aarch64-linux-gnu-glibc-2.17.tar.gz
              displayName: Copy aarch64 glibc 2.17 toolchain
            - script: cp $(Pipeline.Workspace)/arm-rpi-linux-gnueabihf-glibc-2.17/arm-rpi-linux-gnueabihf-glibc-2.17.tar.gz $(Build.ArtifactStagingDirectory)/arm-rpi-linux-gnueabihf-glibc-2.17.tar.gz
              displayName: Copy armhf glibc 2.17 toolchain
            - script: (cd $(Build.ArtifactStagingDirectory) ; shasum -a 256 *.tar.gz) > $(Build.ArtifactStagingDirectory)/SHASUMS256.txt
              displayName: Compute checksums
            - task: GithubRelease@1
              displayName: Create GitHub Release
              inputs:
                gitHubConnection: oauth
                repositoryName: microsoft/vscode-linux-build-agent
                action: create
                addChangeLog: false
                tagSource: userSpecifiedTag
                tag: v$(currentDate)-$(Build.BuildId)

  - stage: Containers
    dependsOn: []
    jobs:
      - job: alpine_x64
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - template: build-containers.yml
            parameters:
              arch: alpine-x64
              release: ${{ parameters.dockerhub_release }}

      - job: alpine_arm64
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - template: build-containers.yml
            parameters:
              qemu: 'true'
              arch: alpine-arm64
              release: ${{ parameters.dockerhub_release }}

      - job: snapcraft_x64
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - template: build-containers.yml
            parameters:
              arch: snapcraft-x64
              release: ${{ parameters.dockerhub_release }}

      - job: centos_x64
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - template: build-containers.yml
            parameters:
              arch: centos7-devtoolset8-x64
              release: ${{ parameters.dockerhub_release }}

      - job: centos_arm64
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - template: build-containers.yml
            parameters:
              arch: centos7-devtoolset8-arm64
              release: ${{ parameters.dockerhub_release }}

      - job: bionic_armhf
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - template: build-containers.yml
            parameters:
              arch: bionic-arm32v7
              release: ${{ parameters.dockerhub_release }}
