steps:
- ${{ if eq(parameters.qemu, 'true') }}:
  - script: docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
    displayName: 'Register Docker QEMU'
- task: 1ES.BuildContainerImage@1
  inputs:
    image: vscodehub.azurecr.io/vscode-linux-build-agent:${{ parameters.arch }}
    path: ${{ parameters.arch }}
    dockerfile: ${{ parameters.arch }}/Dockerfile
    enableNetwork: true
- task: AzureCLI@2
  displayName: Azure CLI
  inputs:
    azureSubscription: vscode
    scriptType: ps
    scriptLocation: inlineScript
    inlineScript: |
      az acr login --name vscodehub
      docker push vscodehub.azurecr.io/vscode-linux-build-agent:${{ parameters.arch }}
  condition: and(succeeded(), eq(${{ parameters.release }}, true))
